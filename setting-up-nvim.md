# Гайд по установки моего сетапа Neovim

## Установка **Neovim**

Полезные ссылки:
- [Репозиторий проекта](https://github.com/neovim/neovim)
- [wiki проекта](https://github.com/neovim/neovim/wiki)


**Neovim** прекрасно ставится при помощи пакетного менеджена, но там его версия значительно более ранняя, чем актуальная стабильная версия.
Для того, чтобы иметь возможность пользоваться всеми возможностями, которые сейчас в нем доступны, а, к слову сказать, доступно там немало различных возможностей, требуется поставить последнюю стабильную версию.
Посмотреть инструкцию можно на официальной [странице](https://github.com/neovim/neovim/wiki/Building-Neovim) проекта, посвященной сборке **neovim**.

```bash
# Устанавливаем все необходимые зависимости и пакеты
sudo apt-get install ninja-build gettext libtool libtool-bin autoconf automake cmake g++ pkg-config unzip curl doxygen

# Скачиваем репозиторий на машину
git clone https://github.com/neovim/neovim


cd neovim && make CMAKE_BUILD_TYPE=RelWithDebInfo # Данная команда производит сборку проекта
git checkout stable #(Опционально) для перехода на стабильную ветку (выполнить перед сборкой)
# Стоит учесть, что если не присвоить переменной CMAKE_BUILD_TYPE, поставится Debug версия сборки, которая подтормаживает
sudo make install # сборка проекта
```

## Установка менеджера пакетов **Vim-Plug**

На самом деле пакетных менеджеров достаточно большое количество, но учитывая, что я уже довольно-таки длительное время пользуюсь именно этим пакетным менеджером, я уже к нему привык.
Да и мои конфиги написаны с учетом того, что я испольльзую именно этот пакетный менеджер.

[Ссылка на git репозиторий](https://github.com/junegunn/vim-plug)

Команда для установки **vim-plug** для **nvim**
```bash
sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
       https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
```

## Установка **dotnet**

В установке **dotnet** на машине нет ничего необходимого, так как nvim будет прекрасно работать без него.
Но через несколько шагов мне придется устанавливать пакет для поддержки lsp, основная задача которого - помощь в программировании на том языке, на котором ты пишешь.
И для того, чтобы он работал с **csharp** просто необходимо, чтобы dotnet был установлен в системе.

```bash
# Скачиваем скрипт для установки dotnet
cd
mkdir Scripts
cd Scripts
wget https://dot.net/v1/dotnet-install.sh
# Запускаем скрипт таким образом, чтобы поставить пятую версию dotnet
bash dotnet-install.sh -c 5.0 # Если запустить от имени администратора, тогда dotnet установится в директорию root'а
bash dotnet-install.sh # так же устанавливаем последнюю версию для того, чтобы можно было поставить актуальную версию language server'а
```

Так же после установки для того, чтобы данная программа появилась в переменных окружения и функционировала нормально, нужно дополнительно прописать переменные окружения в файл **.bashrc**

```bash
export PATH=$PATH:$HOME/.dotnet
export DOTNET_ROOT=$HOME/.dotnet
```
Данные операции в fish будут отличаться, так как там не нужно будет править конфигурационный файл, а нужно будет ввести следующие команды:
```
set -U fish_user_paths $HOME/.dotnet $fish_user_paths
set -xU DOTNET_ROOT $HOME/.dotnet/
```


После чего выйти из файла и произвести из него чтение (или просто перезагрузить систему - тогда чтение файла произойдет автоматически при запуске)

```bash
source ~/.bashrc
```

## Скачивание моих конфигураций с **github** репозитория

```bash
cd ~/Repos
git clone https://github.com/mefioculus/configs_and_scripts
```

После этого на компьютере появится мой репозиторий для переноса конфигов.
Для того, чтобы установить конфиг **nvim**, который я применяю, нужно будет перейти в директорию **scripts** и запустить там скрипт import\_nvim\_config.sh.
Данная команда произведен копирование скрипта в нужную директорию, после чего можно будет зайти в vim и поставить все необходимые плагины при помощи команды :PlugInstall.

## Дальнейшие настройки

Большая часть настроек подтянется из файла **init.vim**, правда это не заставит корректно работать сервер lsp для **csharp**.

Для того, чтобы начать пользоваться возможностями lsp, для начала нужно будет установить сервер языка csharp.

Инструкции по установке можно найти по данной [ссылке](https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md#csharp_ls)

На данной странице указано, что предпочтительный способ установки сервера производится через команду

```bash
dotnet tool install --global csharp-ls
```

Если установка производится для старой версии, может возникнуть ошибка. В таком случае нужно поставить более старую версию csharp-ls:

```bash
dotnet tool install --global csharp-ls --version 0.1.5
```

После установки приложение напишет, что для того, чтобы использовать данные инструменты, нужно будет дополнительно в переменную окружения дописать путь ~/.dotnet/tools

Для этого мы прописываем следующую строку в .bashrc файле

```bash
export PATH=$PATH:$HOME/.dotnet/tools
```
Для fish
```bash
set -U fish_user_paths $HOME/.dotnet/tools/ $fish_user_paths
```

и после этого source'им файл для обновления переменной в текущей сессии.

Все остальные настройки, которые необходимы для работы плагинов уже прописаны в init.vim файле.

## Нюансы

Первоначальная настройка, которая полностью производилась мной вручную (еще до написания данного гайда), проводилась на малинке, путем проб и ошибок.
В ее процессе я составлял конфигурационный файл постепенно, плагины устанавливал по одному, и понятное дело, не приступал к следущему плагину, пока текущий не начинал работать так, как я от него ожидал.
Вторая установка была на моем домашнем ПК, в ее процессе я начал писать данный гайд, и там уже я сразу пользовался готовым **init** файлом (который используется на предыдущем шаге).
После беглой проверки, а так же отключении одного из плагинов (плагин, который отвечал за гит, так как из-за него у меня жутко лагал ввод текста), я через некоторое время начал ставить уже по написанному гайду **nvim** на рабочей машине.

И вот тут я обнаружил одну проблему, которой, на удивлене не было на малинке (там, где я **init** файл писал постепенно, а не использовал готовый).
**LspServer** на домашней и на рабочей машине не работал, вернее, он корректно подключался, но заявленная функциональность не появлялась.

Как потом методом проб и ошибок было выявлено, проблема была видимо в том, что плагины установились в неправильном порядке, и видимо какая-то переменная не была присвоена, из-за чего функциональность не подхватывалась.
Решить данную проблему получилось добавив в **init** файл строку с включением дебаг логов плагина nvim-lspconfig.

```lua
lua << EOF
vim.lsp.set_log_level("debug")
EOF
```
После добавления этой команды все сразу заработало (и после отключения данной команды продолжило работать, поэтому я решил добавить эту строку в конфиг, чтобы она изначально присутствовала (но ее можно было, допустим, потом закоментить).

## Удаление **neovim**
Так же в некоторых случаях может потребоваться удаление nvim.
Для этого желательно воспользоваться командами

```bash
sudo rm /usr/local/bin/nvim
sudo rm -r /usr/local/share/nvim/
```

## Проверка перформанса

Для проверки перформанса можно воспользолваться следующими командами:

```
:profile start profile.log
:profile func *
:profile file *
" At this point do slow actions
:profile pause
:noautocmd qall!
```

Данные команды создадут файл в текущей директории, в который будет писаться лог всех действий, которые выполялись в процессе работы данных команд
