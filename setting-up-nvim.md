# Гайд по установки моего сетапа Neovim

## Установка **Neovim**

Полезные ссылки:
- [Репозиторий проекта](https://github.com/neovim/neovim)
- [wiki проекта](https://github.com/neovim/neovim/wiki)


**Neovim** прекрасно ставится при помощи пакетного менеджена, но там его версия значительно более ранняя, чем актуальная стабильная версия.
Для того, чтобы иметь возможность пользоваться всеми возможностями, которые сейчас в нем доступны, а, к слову сказать, доступно там немало различных возможностей, требуется поставить последнюю стабильную версию.
Посмотреть инструкцию можно на официальной [странице](https://github.com/neovim/neovim/wiki/Building-Neovim) проекта, посвященной сборке **neovim**.

```bash
# Устанавливаем все необходимые зависимости и пакеты
sudo apt-get install ninja-build gettext libtool libtool-bin autoconf automake cmake g++ pkg-config unzip curl doxygen

# Скачиваем репозиторий на машину
git clone https://github.com/neovim/neovim


cd neovim && make CMAKE_BUILD_TYPE=RelWithDebInfo # Данная команда производит сборку проекта
git checkout stable #(Опционально) для перехода на стабильную ветку (выполнить перед сборкой)
# Стоит учесть, что если не присвоить переменной CMAKE_BUILD_TYPE, поставится Debug версия сборки, которая подтормаживает
sudo make install # сборка проекта
```

## Установка менеджера пакетов **Vim-Plug**

На самом деле пакетных менеджеров достаточно большое количество, но учитывая, что я уже довольно-таки длительное время пользуюсь именно этим пакетным менеджером, я уже к нему привык.
Да и мои конфиги написаны с учетом того, что я испольльзую именно этот пакетный менеджер.

[Ссылка на git репозиторий](https://github.com/junegunn/vim-plug)

Команда для установки **vim-plug** для **nvim**
```bash
sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
       https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
```

## Установка **dotnet**

В установке **dotnet** на машине нет ничего необходимого, так как nvim будет прекрасно работать без него.
Но через несколько шагов мне придется устанавливать пакет для поддержки lsp, основная задача которого - помощь в программировании на том языке, на котором ты пишешь.
И для того, чтобы он работал с **csharp** просто необходимо, чтобы dotnet был установлен в системе.

```bash
# Скачиваем скрипт для установки dotnet
cd
mkdir Scripts
cd Scripts
wget https://dot.net/v1/dotnet-install.sh
# Запускаем скрипт таким образом, чтобы поставить пятую версию dotnet
bash dotnet-install.sh -c 5.0 # Если запустить от имени администратора, тогда dotnet установится в директорию root'а
bash dotnet-install.sh # так же устанавливаем последнюю версию для того, чтобы можно было поставить актуальную версию language server'а
```

Так же после установки для того, чтобы данная программа появилась в переменных окружения и функционировала нормально, нужно дополнительно прописать переменные окружения в файл **.bashrc**

```bash
export PATH=$PATH:$HOME/.dotnet
export DOTNET_ROOT=$HOME/.dotnet
```
Данные операции в fish будут отличаться, так как там не нужно будет править конфигурационный файл, а нужно будет ввести следующие команды:
```
set -U fish_user_paths $HOME/.dotnet $fish_user_paths
set -xU DOTNET_ROOT $HOME/.dotnet/
```


После чего выйти из файла и произвести из него чтение (или просто перезагрузить систему - тогда чтение файла произойдет автоматически при запуске)

```bash
source ~/.bashrc
```

## Установка Rust

Rust устанавливается не так сложно, как можно было подумать.
В случае с линуксом можно воспользоваться следующей командой:

```bash
curl https://sh.rustup.rs -sSf | sh
```

Данная команда скачает скрипт установки **cargo** на компьютер и сразу запустит его в терминале.

Так же, для того, чтобы можно было пользоваться установленными утилитами, нужно будет добавить в переменные окружения следующий путь `$HOME/.cargo/bin`, в котором находится все то, что мы установили предыдущей командой.
В **bash** для того, чтобы добавить этот путь, можно прописать следующее в файле **bashrc**:

```bash
export PATH="$HOME/.cargo/bin:$PATH"
```

Но так как я пользуюсь терминалом **fish**, то я это делаю следующей командой:

```bash
set -U fish_user_paths $HOME/.cargo/bin fish_user_paths
```

Все, после этого все необходимое для функционирования **Rust** установлено на машине

## Скачивание моих конфигураций с **github** репозитория

```bash
cd ~/Repos
git clone https://github.com/mefioculus/configs_and_scripts
```

После этого на компьютере появится мой репозиторий для переноса конфигов.
Для того, чтобы установить конфиг **nvim**, который я применяю, нужно будет перейти в директорию **scripts** и запустить там скрипт import\_nvim\_config.sh.
Данная команда произведен копирование скрипта в нужную директорию, после чего можно будет зайти в vim и поставить все необходимые плагины при помощи команды :PlugInstall.

**Важно**
Когда я запускал скрипт, он почему-то не переносил последний init файл, который находился в самом репозитории, поэтому на данный момент лучше всего не польльзуясь скриптом вручную переместить файл **init.vim** в директорию ~/.config/nvim/

## Дальнейшие настройки

### Конфигурация языковых серверов

Большая часть настроек подтянется из файла **init.vim**, правда это не заставит корректно работать сервер lsp для **csharp**.

Для того, чтобы начать пользоваться возможностями lsp, для начала нужно будет установить сервер языка csharp.
Основная сложность заключается в том, что на самом деле для **C#** есть два (а может быть и больше) языковых сервера.
И так же проблемой является то, что на данный момент один из них работает у меня только на малинке, так что я планирую попробовать поставить второй на те машины, где первый не работает.
На всякий случай оставлю в этом гайде оба варианта, чтобы в дальнейшем можно было бы между ними проще переключаться.



Инструкции по установке можно найти по данным ссылкам:
- [csharp_ls](https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md#csharp_ls)
- [omnisharp](https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md#omnisharp)

#### **csharp_ls**

На данной странице указано, что предпочтительный способ установки сервера производится через команду

```bash
dotnet tool install --global csharp-ls # для установки последней верси
dotnet tool install --global csharp-ls --version 0.1.5 # для установки произвольной версии

# так же может возникнуть ситуация, при которой потребуется переустановка.
# в таком случае для удаления данного пакета можно воспользоваться следующей командой:
dotnet tool uninstall --global csharp-ls
```

После установки приложение напишет, что для того, чтобы использовать данные инструменты, нужно будет дополнительно в переменную окружения дописать путь ~/.dotnet/tools.
Для этого мы прописываем следующую строку в .bashrc файле.

```bash
export PATH=$PATH:$HOME/.dotnet/tools
```
Для fish
```bash
set -U fish_user_paths $HOME/.dotnet/tools/ $fish_user_paths
```

и после этого source'им файл для обновления переменной в текущей сессии.

Все остальные настройки, которые необходимы для работы плагинов уже прописаны в init.vim файле.

#### **omnisharp**

В данном случае установка будет несколько сложнее, так как установку по сути придется производить без применения всяческих пакетных менеджеров.
Для начала скачиваем архив на компьютер и разархивируем.
В моем случае я взял версию, которая запакована в tar.gz

Распаковка архива производится при помощи утилиты tar и выглядит следующим образом

```bash
# Создаем директорию, в которую будет производить разорхивирование
cd; mkdir .omnisharp; cd .omnisharp # Так как разорхивирование возможно только в текущую директорию, предварительно перемещаемся в нее

tar xvzf path/to/arcive.tar.gz
```

Производить установку при этом не требуется, так как по сути распакованные файлы и являются всем тем, что требуется.
Но так как данная папка не прописана в переменных окружения, придется прописывать путь в конфигах **neovim**

#### rust_analyzer

На сколько мне известно, на данный момент это единственный lsp сервер, который доступен для **nvim**, правда это предположение я сделал исходя из того, что за пару минут у меня не получилось найти другого сервера.

Для начала нужно будет установить собственно сам сервер.
Описание, как это можно сделать, располагается по данной [ссылке](https://rust-analyzer.github.io/manual.html#rust-analyzer-language-server-binary)

Для **Linux** предложен простой вариант, как можно установить сервер:

```bash
mkdir -p ~/.local/bin
curl -L https://github.com/rust-analyzer/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz | gunzip -c - > ~/.local/bin/rust-analyzer
chmod +x ~/.local/bin/rust-analyzer
```

Помимо этого нужно будет убедиться, что требуемый путь прописан в переменной среды **linux**.
В статье предлагается добавить путь `~/.local/bin`, правда так же в статье сказано, что если уже добавлен путь `~/.cargo/bin` или `usr/local/bin`, все должно работать.
Так что по хорошему этот вариант мне так же нужно будет проверить.

Так же в дополнении в статье сказано, что rust-analyzer нуждается в источниках стандартных библиотек, и если их нет, то он попробует поставить их сам. Но так же можно произвести установку вручную командой:

```bash
rustup component add rust-src
```

Скорее всего данную команду мне не придется выполнять, но на всякий случай я ее сюда пропишу.

После этого остается дело за малым - прописать в конфигах nvim команду для включения сервера **rust-analyzer** при работе с файлами **rust**.

Основная команда, которая для этого требуется прописать:

```
require'lspconfig'.rust_analyzer.setup{}
```

Правда для того, чтобы произвести корректную настройку, скорее всего придется использовать следующее:

```
lua << EOF
local nvim_lsp = require'lspconfig'

local on_attach = function(client)
    require'completion'.on_attach(client)
end

nvim_lsp.rust_analyzer.setup({
    on_attach=on_attach,
    settings = {
        ["rust-analyzer"] = {
            assist = {
                importGranularity = "module",
                importPrefix = "self",
            },
            cargo = {
                loadOutDirsFromCheck = true
            },
            procMacro = {
                enable = true
            },
        }
    }
})
EOF
```

Так же в статье предлагается посетить две ссылки для более глубокого понимания настройки сервера:

- [Больше советов по настройке](https://sharksforarms.dev/posts/neovim-rust/)
- [Готовый сетап с "включенными в комплект батарейками"](https://github.com/simrat39/rust-tools.nvim)

Не знаю, потребуется ли мне это в ближайшем времени (для начала мне бы хватило просто автокомплита, чтобы язык подсказывал мне, какие варианты вообще возможны).
Но кто знает, может быть в итоге эти ссылки сохранят мне много нервов.

### Конфигурация Treesitter

- [Ссылка на репозиторий](https://github.com/nvim-treesitter/nvim-treesitter#quickstart)

Потребуется установка плагина (который прописан в конфиге), а после этого выполнение команды из самого vim

```
:TSInstall <language_to_install>
```

Данная команда произведет все необходимые установка для выбранного языка

## Нюансы

Первоначальная настройка, которая полностью производилась мной вручную (еще до написания данного гайда), проводилась на малинке, путем проб и ошибок.
В ее процессе я составлял конфигурационный файл постепенно, плагины устанавливал по одному, и понятное дело, не приступал к следущему плагину, пока текущий не начинал работать так, как я от него ожидал.
Вторая установка была на моем домашнем ПК, в ее процессе я начал писать данный гайд, и там уже я сразу пользовался готовым **init** файлом (который используется на предыдущем шаге).
После беглой проверки, а так же отключении одного из плагинов (плагин, который отвечал за гит, так как из-за него у меня жутко лагал ввод текста), я через некоторое время начал ставить уже по написанному гайду **nvim** на рабочей машине.

И вот тут я обнаружил одну проблему, которой, на удивлене не было на малинке (там, где я **init** файл писал постепенно, а не использовал готовый).
**LspServer** на домашней и на рабочей машине не работал, вернее, он корректно подключался, но заявленная функциональность не появлялась.

Как потом методом проб и ошибок было выявлено, проблема была видимо в том, что плагины установились в неправильном порядке, и видимо какая-то переменная не была присвоена, из-за чего функциональность не подхватывалась.
Решить данную проблему получилось добавив в **init** файл строку с включением дебаг логов плагина nvim-lspconfig.

```lua
lua << EOF
vim.lsp.set_log_level("debug")
EOF
```
После добавления этой команды все сразу заработало (и после отключения данной команды продолжило работать, поэтому я решил добавить эту строку в конфиг, чтобы она изначально присутствовала (но ее можно было, допустим, потом закоментить).

## Удаление **neovim**
Так же в некоторых случаях может потребоваться удаление nvim.
Для этого желательно воспользоваться командами

```bash
sudo rm /usr/local/bin/nvim
sudo rm -r /usr/local/share/nvim/
```

Так же помимо удаления vim может потребоваться удаление и всех плагинов, которые были вместе с ним установлены.
Для этого нужно будет пройти в директорию

```bash
cd .nvim/bundle
rm -r *
```

## Проверка перформанса

Для проверки перформанса можно воспользолваться следующими командами:

```
:profile start profile.log
:profile func *
:profile file *
" At this point do slow actions
:profile pause
:noautocmd qall!
```

Данные команды создадут файл в текущей директории, в который будет писаться лог всех действий, которые выполялись в процессе работы данных команд

## Чтение логов lsp

Для того, чтобы логи писались в файл (уровень дебаг), нужно воспользоваться конфигом, который дан в разделе **Нюансы**.
Для того, чтобы посмотреть логи, которые при этом были записаны, можно воспользоваться встроенной командой в vim-plug

```bash
:lua vim.cmd('e'..vim.lsp.get_log_path()) # Открываем лог
:w PathToFile # Сохраняем лог в файл
```

Либо же перейти в директорию, в которой располагаются данные логи `$HOME/.local/share/nvim/lsp.log`.
Правда тут стоит отметить тот факт, что не смотря на то, что я пытался найти файлы с таким названием хотя бы где-нибудь в системе, мне это не удалось, так что возможно их просто нет и придется довольствоваться командой выше.
